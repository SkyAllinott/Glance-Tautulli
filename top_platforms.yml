- type: custom-api
  title: Platforms
  cache: 60m
  url: http://${TAUTULLI_IP}:${TAUTULLI_PORT}/api/v2?
  allow-potentially-dangerous-html: true
  parameters:
    time_range: 90
    apikey: ${TAUTULLI_API_KEY}
    cmd: get_home_stats
    stat_id: top_platforms
    stats_type: duration
  template: |
    {{ $isLarge := eq (.Options.StringOr "size" "large") "large" }}
    {{ $serverID := "${SERVER_ID}" }}
    {{ $uniqueID := "top_platforms" }}
    {{ $filter := .Options.StringOr "filter" "none" }}
    {{ $collapse := .Options.IntOr "collapse" 5 }}
    {{ $rows := .JSON.Array "response.data.rows" }}

    {{ if $isLarge }}
      <div style="display: flex; align-items: center; gap: 0.5rem;">

        <!-- Left Arrow -->
        <div id="scrollLeft-{{ $uniqueID }}" title="Scroll left"
          onclick='document.getElementById("scrollContainer-{{ $uniqueID }}").scrollBy({ left: -150, behavior: "smooth" })'
          style="flex: 0 0 2.5rem; height: 100px; display: flex; align-items: center; justify-content: center; background: var(--color-surface); cursor: pointer; user-select: none;">
          <span class="color-primary" style="font-size: 1.5rem; opacity: 0.7;">◀</span>
        </div>

        <!-- Scrollable Content -->
        <div id="scrollContainer-{{ $uniqueID }}"
          style="display: flex; overflow-x: auto; gap: 1rem; padding-block: 0.5rem; scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none;">
          {{ range $v := $rows }}
            {{ $platform := $v.String "platform" }}
            {{ $platformName := $v.String "platform_name" }}
            {{ $img := printf "interfaces/default/images/platforms/%s.svg" $platformName }}
            {{ $seconds := $v.Int "total_duration" }}
            {{ $hours := div $seconds 3600 }}
            {{ $minutes := mod (div $seconds 60) 60 }}

            <div style="min-width: 160px; text-align: center;">
              <div style="max-height: 225px; overflow: hidden; border-radius: 6px;" class="color-primary">
                <img src="http://${TAUTULLI_IP}:${TAUTULLI_PORT}/api/v2?apikey=${TAUTULLI_API_KEY}&cmd=pms_image_proxy&img={{ $img }}"
                  alt="thumb"
                  title="{{ $platform }}"
                  style="width: 100%; height: auto; object-fit: cover; padding: 0 25px; filter: {{ $filter | safeCSS }};" />
              </div>
              <div class="color-highlight"
                style="margin-top: 1rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;"
                title="{{ $platform }}">
                {{ $platform }}
              </div>
              <div class="color-primary">
                <span title="{{ $v.String "player" }}">
                  {{ if gt $hours 0 }}
                    {{ printf "%dh %dm" $hours $minutes }}
                  {{ else }}
                    {{ printf "%dm" $minutes }}
                  {{ end }}
                </span><br />
                <span>
                  {{ $v.String "total_plays" }} Plays
                </span>
              </div>
            </div>
          {{ end }}
        </div>

        <!-- Right Arrow -->
        <div id="scrollRight-{{ $uniqueID }}" title="Scroll right"
          onclick='document.getElementById("scrollContainer-{{ $uniqueID }}").scrollBy({ left: 150, behavior: "smooth" })'
          style="flex: 0 0 2.5rem; height: 100px; display: flex; align-items: center; justify-content: center; background: var(--color-surface); cursor: pointer; user-select: none;">
          <span class="color-primary" style="font-size: 1.5rem; opacity: 0.7;">▶</span>
        </div>
      </div>
    {{ else }}
      <!-- Small Widget -->
      <ul class="list collapsible-container" data-collapse-after="{{ $collapse }}">
        {{ range $v := $rows }}
          {{ $platform := $v.String "platform" }}
          {{ $platformName := $v.String "platform_name" }}
          {{ $img := printf "interfaces/default/images/platforms/%s.svg" $platformName }}
          {{ $seconds := $v.Int "total_duration" }}
          {{ $hours := div $seconds 3600 }}
          {{ $minutes := mod (div $seconds 60) 60 }}

          <li class="flex items-center gap-2" style="padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
            <img src="http://${TAUTULLI_IP}:${TAUTULLI_PORT}/api/v2?apikey=${TAUTULLI_API_KEY}&cmd=pms_image_proxy&img={{ $img }}"
              alt="thumb"
              title="{{ $platform }}"
              style="width: 50px; margin-right: 1.5rem; filter: {{ $filter | safeCSS }};"
              class="rounded w-10 h-10 object-cover" />
            <div class="min-width-0 grow">
              <div class="color-highlight"
                style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis;"
                title="{{ $platform }}">
                {{ $platform }}
              </div>
              <div class="color-primary">
                <span title="{{ $v.String "player" }}">
                  {{ if gt $hours 0 }}
                    {{ printf "%dh %dm" $hours $minutes }}
                  {{ else }}
                    {{ printf "%dm" $minutes }}
                  {{ end }}
                </span> •
                <span>{{ $v.String "total_plays" }} Plays</span>
              </div>
            </div>
          </li>
        {{ end }}
      </ul>
    {{ end }}